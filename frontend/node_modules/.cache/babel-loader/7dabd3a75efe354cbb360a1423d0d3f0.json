{"ast":null,"code":"import _toConsumableArray from\"/Users/jucenirleonardo/Documents/GitHub/whaticket_saas/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"/Users/jucenirleonardo/Documents/GitHub/whaticket_saas/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _defineProperty from\"/Users/jucenirleonardo/Documents/GitHub/whaticket_saas/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _objectSpread from\"/Users/jucenirleonardo/Documents/GitHub/whaticket_saas/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import React,{useState,useRef,useEffect,useContext}from\"react\";import{useHistory}from\"react-router-dom\";import{format}from\"date-fns\";import useSound from\"use-sound\";import Popover from\"@material-ui/core/Popover\";import IconButton from\"@material-ui/core/IconButton\";import List from\"@material-ui/core/List\";import ListItem from\"@material-ui/core/ListItem\";import ListItemText from\"@material-ui/core/ListItemText\";import{makeStyles}from\"@material-ui/core/styles\";import Badge from\"@material-ui/core/Badge\";import ChatIcon from\"@material-ui/icons/Chat\";import TicketListItem from\"../TicketListItem\";import{i18n}from\"../../translate/i18n\";import useTickets from\"../../hooks/useTickets\";import alertSound from\"../../assets/sound.mp3\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{socketConnection}from\"../../services/socket\";var useStyles=makeStyles(function(theme){return{tabContainer:_objectSpread({overflowY:\"auto\",maxHeight:350},theme.scrollbarStyles),popoverPaper:_defineProperty({width:\"100%\",maxWidth:350,marginLeft:theme.spacing(2),marginRight:theme.spacing(1)},theme.breakpoints.down(\"sm\"),{maxWidth:270}),noShadow:{boxShadow:\"none !important\"}};});var NotificationsPopOver=function NotificationsPopOver(){var classes=useStyles();var history=useHistory();var _useContext=useContext(AuthContext),user=_useContext.user;var ticketIdUrl=+history.location.pathname.split(\"/\")[2];var ticketIdRef=useRef(ticketIdUrl);var anchorEl=useRef();var _useState=useState(false),_useState2=_slicedToArray(_useState,2),isOpen=_useState2[0],setIsOpen=_useState2[1];var _useState3=useState([]),_useState4=_slicedToArray(_useState3,2),notifications=_useState4[0],setNotifications=_useState4[1];var profile=user.profile,queues=user.queues;var _useState5=useState([]),_useState6=_slicedToArray(_useState5,2),setDesktopNotifications=_useState6[1];var _useTickets=useTickets({withUnreadMessages:\"true\"}),tickets=_useTickets.tickets;var _useSound=useSound(alertSound),_useSound2=_slicedToArray(_useSound,1),play=_useSound2[0];var soundAlertRef=useRef();var historyRef=useRef(history);useEffect(function(){soundAlertRef.current=play;if(!(\"Notification\"in window)){console.log(\"This browser doesn't support notifications\");}else{Notification.requestPermission();}},[play]);useEffect(function(){setNotifications(tickets);},[tickets]);useEffect(function(){ticketIdRef.current=ticketIdUrl;},[ticketIdUrl]);useEffect(function(){var companyId=localStorage.getItem(\"companyId\");var socket=socketConnection({companyId:companyId});var queueIds=queues.map(function(q){return q.id;});socket.on(\"connect\",function(){return socket.emit(\"joinNotification\");});socket.on(\"company-\".concat(companyId,\"-ticket\"),function(data){if(data.action===\"updateUnread\"||data.action===\"delete\"){setNotifications(function(prevState){var ticketIndex=prevState.findIndex(function(t){return t.id===data.ticketId;});if(ticketIndex!==-1){prevState.splice(ticketIndex,1);return _toConsumableArray(prevState);}return prevState;});setDesktopNotifications(function(prevState){var notfiticationIndex=prevState.findIndex(function(n){return n.tag===String(data.ticketId);});if(notfiticationIndex!==-1){prevState[notfiticationIndex].close();prevState.splice(notfiticationIndex,1);return _toConsumableArray(prevState);}return prevState;});}});socket.on(\"company-\".concat(companyId,\"-appMessage\"),function(data){if(data.action===\"create\"&&!data.message.read&&(data.ticket.userId===(user===null||user===void 0?void 0:user.id)||!data.ticket.userId)){setNotifications(function(prevState){var ticketIndex=prevState.findIndex(function(t){return t.id===data.ticket.id;});if(ticketIndex!==-1){prevState[ticketIndex]=data.ticket;return _toConsumableArray(prevState);}return[data.ticket].concat(_toConsumableArray(prevState));});var shouldNotNotificate=data.message.ticketId===ticketIdRef.current&&document.visibilityState===\"visible\"||data.ticket.userId&&data.ticket.userId!==(user===null||user===void 0?void 0:user.id)||data.ticket.isGroup;if(shouldNotNotificate)return;handleNotifications(data);}});return function(){socket.disconnect();};},[user,profile,queues]);var handleNotifications=function handleNotifications(data){var message=data.message,contact=data.contact,ticket=data.ticket;var options={body:\"\".concat(message.body,\" - \").concat(format(new Date(),\"HH:mm\")),icon:contact.profilePicUrl,tag:ticket.id,renotify:true};var notification=new Notification(\"\".concat(i18n.t(\"tickets.notification.message\"),\" \").concat(contact.name),options);notification.onclick=function(e){e.preventDefault();window.focus();historyRef.current.push(\"/tickets/\".concat(ticket.uuid));};setDesktopNotifications(function(prevState){var notfiticationIndex=prevState.findIndex(function(n){return n.tag===notification.tag;});if(notfiticationIndex!==-1){prevState[notfiticationIndex]=notification;return _toConsumableArray(prevState);}return[notification].concat(_toConsumableArray(prevState));});soundAlertRef.current();};var handleClick=function handleClick(){setIsOpen(function(prevState){return!prevState;});};var handleClickAway=function handleClickAway(){setIsOpen(false);};var NotificationTicket=function NotificationTicket(_ref){var children=_ref.children;return/*#__PURE__*/React.createElement(\"div\",{onClick:handleClickAway},children);};return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(IconButton,{onClick:handleClick,ref:anchorEl,\"aria-label\":\"Mostrar Notifica\\xE7\\xF5es\",variant:\"contained\"},/*#__PURE__*/React.createElement(ChatIcon,null)),/*#__PURE__*/React.createElement(Popover,{disableScrollLock:true,open:isOpen,anchorEl:anchorEl.current,anchorOrigin:{vertical:\"bottom\",horizontal:\"right\"},transformOrigin:{vertical:\"top\",horizontal:\"right\"},classes:{paper:classes.popoverPaper},onClose:handleClickAway},/*#__PURE__*/React.createElement(List,{dense:true,className:classes.tabContainer},notifications.length===0?/*#__PURE__*/React.createElement(ListItem,null,/*#__PURE__*/React.createElement(ListItemText,null,i18n.t(\"notifications.noTickets\"))):notifications.map(function(ticket){return/*#__PURE__*/React.createElement(NotificationTicket,{key:ticket.id},/*#__PURE__*/React.createElement(TicketListItem,{ticket:ticket}));}))));};export default NotificationsPopOver;","map":null,"metadata":{},"sourceType":"module"}